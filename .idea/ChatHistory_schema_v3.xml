<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ChatHistoryState">
    <option name="chatSessions" value="{&quot;207feeba-ad2c-4155-b4ba-dcbb5e84b241&quot;:{&quot;id&quot;:&quot;207feeba-ad2c-4155-b4ba-dcbb5e84b241&quot;,&quot;name&quot;:&quot;[TextContent(type\u003dtext, text\u003d\n\u003cadditional_data\u003e\nBelow are some potentially helpful/relevant pieces of information for figuring out to respond\n\u003ccurrent_file\u003e\n```kotlin:app/src/main/java/jnu/kulipai/exam/ui/screens/home/HomeViewModel.kt, lines\u003dALL(1-310)\npackage jnu.kulipai.exam.ui.screens.home\n\nimport android.app.Application\nimport android.content.Intent\nimport android.net.Uri\nimport android.webkit.MimeTypeMap\nimport android.widget.Toast\nimport androidx.activity.result.ActivityResultLauncher\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.core.content.FileProvider\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport jnu.kulipai.exam.AppPreferences\nimport jnu.kulipai.exam.data.model.DirNode\nimport jnu.kulipai.exam.data.model.DownLoadState\nimport jnu.kulipai.exam.data.model.FileItem\nimport jnu.kulipai.exam.data.model.LoadingState\nimport jnu.kulipai.exam.data.repository.FileRepository\nimport jnu.kulipai.exam.ui.theme.ThemeSettingsManager\nimport jnu.kulipai.exam.util.Api\nimport kotlinx.coroutines.Dispatchers\nimport kotlinx.coroutines.delay\nimport kotlinx.coroutines.flow.MutableStateFlow\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.asStateFlow\nimport kotlinx.coroutines.launch\nimport java.io.File\nimport java.io.FileInputStream\nimport java.io.OutputStream\n\n//哇好像很方便，在一个地方统一管理需要context的函数\n//用流来管理全局变量，神奇的感觉:))))))\n\nclass HomeViewModel(\n    private val fileRepository: FileRepository,\n    private val appPreferences: AppPreferences,\n    private val application: Application,\n    private val themeSettingsManager: ThemeSettingsManager,\n\n    ) : ViewModel() {\n\n\n    var currentFile \u003d MutableStateFlow(File(\&quot;/\&quot;))\n\n\n    val darkTheme \u003d themeSettingsManager.darkTheme\n\n    fun updateDarkTheme(value: Int) \u003d\n        viewModelScope.launch(Dispatchers.IO) {\n            themeSettingsManager.setDarkTheme(value)\n        }\n\n\n    private var exportLauncher: ActivityResultLauncher\u003cString\u003e? \u003d null\n    fun setExportLauncher(arl: ActivityResultLauncher\u003cString\u003e) {\n        exportLauncher \u003d arl\n    }\n\n    lateinit var exportPath: String\n\n    private var _isSearch \u003d MutableStateFlow(false)\n    var isSearch \u003d _isSearch.asStateFlow()\n\n    fun setisSearch(bool: Boolean) {\n        _isSearch.value \u003d bool\n    }\n\n    val appPre \u003d appPreferences\n\n    private var _searchText \u003d MutableStateFlow(\&quot;\&quot;)\n    var searchText \u003d _searchText.asStateFlow()\n\n    fun setSearchText(text: String) {\n        _searchText.value \u003d text\n    }\n\n    private val _loadingState \u003d MutableStateFlow(LoadingState.Loading)\n    val loadingState: StateFlow\u003cLoadingState\u003e \u003d _loadingState.asStateFlow()\n\n\n    fun setLoadingState(newState: LoadingState) {\n        _loadingState.value \u003d newState // 只有在 ViewModel 内部才能修改 _loadingState.value\n    }\n\n\n    private val _currentPath \u003d MutableStateFlow(\&quot;/\&quot;)\n    val currentPath: StateFlow\u003cString\u003e \u003d _currentPath.asStateFlow()\n\n    private var _root \u003d MutableStateFlow(DirNode(\&quot;root\&quot;, \&quot;/\&quot;)) // ViewModel 持有 root 节点\n    val root: StateFlow\u003cDirNode\u003e \u003d _root\n\n\n    init {\n        loadDirectoryTree() // ViewModel 初始化时加载数据\n    }\n\n    private fun loadDirectoryTree() {\n        viewModelScope.launch {\n            _loadingState.value \u003d LoadingState.Loading\n            try {\n                _root.value \u003d fileRepository.getDirectoryTree(application) // 传入 application context\n                _loadingState.value \u003d LoadingState.Loaded\n            } catch (e: Exception) {\n                Toast.makeText(application, \&quot;加载失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n                _loadingState.value \u003d LoadingState.Err // 加载失败时进入错误状态\n            }\n        }\n    }\n\n    fun navigateTo(folderName: String) {\n        viewModelScope.launch {\n            _loadingState.value \u003d LoadingState.Step\n            delay(80) // 模拟动画或操作延迟\n            _currentPath.value \u003d if (folderName \u003d\u003d \&quot;..\&quot;) {\n                Api.DotDot(_currentPath.value)\n            } else {\n                _currentPath.value + \&quot;$folderName/\&quot;\n            }\n//            delay(100) // 模拟动画或操作延迟\n            _loadingState.value \u003d LoadingState.Loaded\n        }\n    }\n\n    fun handleBackPress() {\n        if (_currentPath.value !\u003d \&quot;/\&quot;) {\n            viewModelScope.launch {\n                _loadingState.value \u003d LoadingState.Step\n                delay(250)\n                _currentPath.value \u003d Api.DotDot(_currentPath.value)\n                _loadingState.value \u003d LoadingState.Loaded\n            }\n        } else {\n            // 如果在根目录，可以考虑关闭应用或者不作处理，具体取决于需求\n            // 注意：在 ViewModel 中不应该直接调用 finish()，而是通过事件回调通知 UI\n//            Toast.makeText(application, \&quot;已经在根目录啦\&quot;, Toast.LENGTH_SHORT).show()\n        }\n    }\n\n    fun updateRepositoryData() {\n        viewModelScope.launch {\n            _loadingState.value \u003d LoadingState.Loading\n            try {\n                File(application.filesDir, \&quot;cache.json\&quot;).delete()\n\n                // 这里直接调用 repository 的逻辑\n                val newRoot \u003d\n                    fileRepository.getDirectoryTree(application) // 假设 repository 有一个 forceUpdate 参数\n                _root.value \u003d newRoot\n                _loadingState.value \u003d LoadingState.Loaded\n                appPreferences.day \u003d System.currentTimeMillis()\n                Toast.makeText(application, \&quot;数据已更新！\&quot;, Toast.LENGTH_SHORT).show()\n            } catch (e: Exception) {\n                Toast.makeText(application, \&quot;更新失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n                _loadingState.value \u003d LoadingState.Loaded // 即使失败也要回到 Loaded 状态\n            }\n        }\n    }\n\n    // 可以添加文件下载的逻辑到 ViewModel\n    fun downloadFile(fileItem: FileItem, downloadCallback: (DownLoadState) -\u003e Unit) {\n        viewModelScope.launch {\n            downloadCallback(DownLoadState.DownLoading)\n            try {\n                val url \u003d fileItem.url\n                Api.downloadFileToInternal(\n                    application, // 使用 application context\n                    url,\n                    fileItem.path,\n                    true,\n                    { downloadCallback(DownLoadState.Downloaded) },\n                    { downloadCallback(DownLoadState.Err) }\n                )\n            } catch (e: Exception) {\n                Toast.makeText(application, \&quot;下载失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n                downloadCallback(DownLoadState.Err)\n            }\n        }\n    }\n\n\n    fun openFileWithOtherApp(relativePath: String) {\n        val file \u003d File(application.getExternalFilesDir(\&quot;\&quot;), relativePath)\n        if (!file.exists()) {\n            throw IllegalArgumentException(\&quot;File does not exist: $relativePath\&quot;)\n        }\n\n        val extension \u003d file.extension.lowercase()\n        val fallbackMimeTypes \u003d mapOf(\n            \&quot;md\&quot; to \&quot;text/plain\&quot;,\n            \&quot;markdown\&quot; to \&quot;text/plain\&quot;,\n            \&quot;lua\&quot; to \&quot;text/plain\&quot;,\n            \&quot;log\&quot; to \&quot;text/plain\&quot;,\n            \&quot;json\&quot; to \&quot;application/json\&quot;,\n            \&quot;xml\&quot; to \&quot;text/xml\&quot;,\n            \&quot;csv\&quot; to \&quot;text/csv\&quot;\n        )\n\n        val mimeType \u003d MimeTypeMap.getSingleton()\n            .getMimeTypeFromExtension(extension)\n            ?: fallbackMimeTypes[extension]\n            ?: \&quot;application/octet-stream\&quot;\n\n        val uri: Uri \u003d FileProvider.getUriForFile(\n            application,\n            \&quot;${application.packageName}.fileprovider\&quot;,\n            file\n        )\n\n        val intent \u003d Intent(Intent.ACTION_VIEW).apply {\n            setDataAndType(uri, mimeType)\n            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)\n            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK) // ✅ 必须加，因是 application context\n        }\n\n        val chooser \u003d Intent.createChooser(intent, \&quot;选择应用打开文件\&quot;).apply {\n            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK) // ✅ Chooser 也加\n        }\n\n        try {\n            application.startActivity(chooser)\n        } catch (e: Exception) {\n            Toast.makeText(\n                application, \&quot;找不到应用打开此文件，路径: $relativePath，类型: $mimeType\&quot;,\n                Toast.LENGTH_SHORT\n            ).show()\n        }\n    }\n\n    fun exportFileToUri(relativePath: String, targetUri: Uri) {\n        val file \u003d File(application.getExternalFilesDir(\&quot;\&quot;), relativePath)\n        if (!file.exists()) {\n            Toast.makeText(application, \&quot;源文件不存在: $relativePath\&quot;, Toast.LENGTH_SHORT).show()\n            return\n        }\n\n        try {\n            val inputStream \u003d FileInputStream(file)\n            val outputStream: OutputStream? \u003d\n                application.contentResolver.openOutputStream(targetUri)\n\n            if (outputStream \u003d\u003d null) {\n                Toast.makeText(application, \&quot;无法打开导出目标\&quot;, Toast.LENGTH_SHORT).show()\n                return\n            }\n\n            inputStream.use { input -\u003e\n                outputStream.use { output -\u003e\n                    input.copyTo(output)\n                }\n            }\n\n            Toast.makeText(application, \&quot;文件已成功导出\&quot;, Toast.LENGTH_SHORT).show()\n\n        } catch (e: Exception) {\n            e.printStackTrace()\n            Toast.makeText(application, \&quot;导出失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n        }\n    }\n\n\n    fun createExportLauncher(\n        mime: String,\n        onResult: (Uri?) -\u003e Unit\n    ): ActivityResultLauncher\u003cString\u003e {\n        return application.registerForActivityResult(\n            ActivityResultContracts.CreateDocument(mime),\n            onResult\n        )\n    }\n\n    fun exportFile(relativePath: String) {\n        val fileName \u003d File(relativePath).name\n        val mime \u003d guessMimeType(fileName)\n\n        exportPath \u003d relativePath\n\n        val launcher \u003d createExportLauncher(mime) { uri -\u003e\n            uri?.let { exportFileToUri(relativePath, it) }\n        }\n\n        launcher.launch(fileName)\n    }\n\n\n    fun guessMimeType(fileName: String): String {\n        val ext \u003d fileName.substringAfterLast(\u0027.\u0027, \&quot;\&quot;).lowercase()\n        return when (ext) {\n            \&quot;pdf\&quot; -\u003e \&quot;application/pdf\&quot;\n            \&quot;jpg\&quot;, \&quot;jpeg\&quot; -\u003e \&quot;image/jpeg\&quot;\n            \&quot;png\&quot; -\u003e \&quot;image/png\&quot;\n            \&quot;webp\&quot; -\u003e \&quot;image/webp\&quot;\n            \&quot;mp4\&quot; -\u003e \&quot;video/mp4\&quot;\n            \&quot;mp3\&quot; -\u003e \&quot;audio/mpeg\&quot;\n            \&quot;txt\&quot; -\u003e \&quot;text/plain\&quot;\n            \&quot;json\&quot; -\u003e \&quot;application/json\&quot;\n            \&quot;zip\&quot; -\u003e \&quot;application/zip\&quot;\n            \&quot;rar\&quot; -\u003e \&quot;application/vnd.rar\&quot;\n            \&quot;7z\&quot; -\u003e \&quot;application/x-7z-compressed\&quot;\n            \&quot;apk\&quot; -\u003e \&quot;application/vnd.android.package-archive\&quot;\n            \&quot;doc\&quot; -\u003e \&quot;application/msword\&quot;\n            \&quot;docx\&quot; -\u003e \&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document\&quot;\n            \&quot;xls\&quot; -\u003e \&quot;application/vnd.ms-excel\&quot;\n            \&quot;xlsx\&quot; -\u003e \&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\&quot;\n            else -\u003e \&quot;application/octet-stream\&quot; // 兜底，关键！\n        }\n    }\n\n\n\n}\n```\n\u003c/current_file\u003e\n\n\n\u003clinter_errors\u003e\n## Linter Errors\n\nPath: app/src/main/java/jnu/kulipai/exam/ui/screens/home/HomeViewModel.kt\nErrors:\n\nLine 265: Unresolved reference \u0027registerForActivityResult\u0027.\n\u003c/linter_errors\u003e\n\n\n\u003cattached_files\u003e\n\u003cfile_contents\u003e\n```kotlin:app/src/main/java/jnu/kulipai/exam/ui/screens/home/HomeScreen.kt, lines\u003dALL(1-571)\npackage jnu.kulipai.exam.ui.screens.home\n\nimport androidx.activity.compose.BackHandler\nimport androidx.activity.compose.rememberLauncherForActivityResult\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.compose.animation.AnimatedContent\nimport androidx.compose.animation.AnimatedVisibility\nimport androidx.compose.animation.SizeTransform\nimport androidx.compose.animation.animateContentSize\nimport androidx.compose.animation.core.tween\nimport androidx.compose.animation.fadeIn\nimport androidx.compose.animation.fadeOut\nimport androidx.compose.animation.slideInHorizontally\nimport androidx.compose.animation.slideOutHorizontally\nimport androidx.compose.animation.togetherWith\nimport androidx.compose.foundation.clickable\nimport androidx.compose.foundation.gestures.detectTapGestures\nimport androidx.compose.foundation.isSystemInDarkTheme\nimport androidx.compose.foundation.layout.Box\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.Spacer\nimport androidx.compose.foundation.layout.WindowInsets\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.height\nimport androidx.compose.foundation.layout.navigationBarsPadding\nimport androidx.compose.foundation.layout.offset\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.layout.width\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.foundation.text.BasicText\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Close\nimport androidx.compose.material.icons.filled.Search\nimport androidx.compose.material.icons.filled.Settings\nimport androidx.compose.material3.ExperimentalMaterial3Api\nimport androidx.compose.material3.Icon\nimport androidx.compose.material3.IconButton\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.OutlinedTextField\nimport androidx.compose.material3.Scaffold\nimport androidx.compose.material3.Text\nimport androidx.compose.material3.TopAppBar\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.LaunchedEffect\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.key\nimport androidx.compose.runtime.mutableIntStateOf\nimport androidx.compose.runtime.mutableLongStateOf\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.saveable.rememberSaveable\nimport androidx.compose.runtime.setValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.drawBehind\nimport androidx.compose.ui.draw.paint\nimport androidx.compose.ui.focus.FocusRequester\nimport androidx.compose.ui.focus.focusRequester\nimport androidx.compose.ui.geometry.Offset\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.graphics.ColorFilter\nimport androidx.compose.ui.input.pointer.pointerInput\nimport androidx.compose.ui.platform.LocalFocusManager\nimport androidx.compose.ui.res.painterResource\nimport androidx.compose.ui.text.TextStyle\nimport androidx.compose.ui.text.style.TextOverflow\nimport androidx.compose.ui.unit.dp\nimport androidx.compose.ui.unit.sp\nimport androidx.lifecycle.compose.collectAsStateWithLifecycle\nimport cafe.adriel.voyager.core.screen.Screen\nimport cafe.adriel.voyager.navigator.LocalNavigator\nimport cafe.adriel.voyager.navigator.Navigator\nimport cafe.adriel.voyager.navigator.currentOrThrow\nimport com.airbnb.lottie.compose.LottieAnimation\nimport com.airbnb.lottie.compose.LottieCompositionSpec\nimport com.airbnb.lottie.compose.LottieConstants\nimport com.airbnb.lottie.compose.animateLottieCompositionAsState\nimport com.airbnb.lottie.compose.rememberLottieComposition\nimport com.kyant.backdrop.backdrops.layerBackdrop\nimport com.kyant.backdrop.backdrops.rememberLayerBackdrop\nimport jnu.kulipai.exam.R\nimport jnu.kulipai.exam.components.BounceUpButton\nimport jnu.kulipai.exam.components.FileCard\nimport jnu.kulipai.exam.components.FolderCard\nimport jnu.kulipai.exam.components.LiquidBottomTab\nimport jnu.kulipai.exam.components.LiquidBottomTabs\nimport jnu.kulipai.exam.components.ThemeToggleButton\nimport jnu.kulipai.exam.data.model.DirNode\nimport jnu.kulipai.exam.data.model.FileItem\nimport jnu.kulipai.exam.data.model.LoadingState\nimport jnu.kulipai.exam.data.model.MaskAnimActive\nimport jnu.kulipai.exam.ui.screens.setting.SettingScreen\nimport jnu.kulipai.exam.ui.util.ScreenshotThemeTransition\nimport jnu.kulipai.exam.util.FileManager\nimport kotlinx.coroutines.CoroutineScope\nimport kotlinx.coroutines.Dispatchers\nimport kotlinx.coroutines.Job\nimport kotlinx.coroutines.delay\nimport kotlinx.coroutines.launch\nimport org.koin.androidx.compose.koinViewModel\n\n\n//这里有笼罩动画，状态栏\nclass MainScreen : Screen {\n\n    @Composable\n    override fun Content() {\n\n        val navigator \u003d LocalNavigator.currentOrThrow\n\n\n        val viewModel: HomeViewModel \u003d koinViewModel()\n        val launcher \u003d\n            rememberLauncherForActivityResult(ActivityResultContracts.CreateDocument(\&quot;text/plain\&quot;)) { uri -\u003e\n                uri?.let {\n                    viewModel.exportFileToUri(viewModel.exportPath, it)\n                }\n            }\n\n        // 设置 launcher 给 ViewModel\n        LaunchedEffect(Unit) {\n            viewModel.setExportLauncher(launcher)\n        }\n        // wow 这个单例原来可以哦哦，对的\n        // 单例然后保存到viewModel然后就获取然后就唯一的\n        // 全局的!\n        val appPrefs \u003d viewModel.appPre\n        // 初始化一次\n\n        // 这个好乱，我问ai怎么优化代码，他让我再写一个类就写一个配置一行代码，我说能不能写进viewModel\n        // ai说x，要写进一个新文件，\n        // 我说f**k(\n        // 已经优化掉了，当我没说\n\n\n        val darkTheme by viewModel.darkTheme.collectAsStateWithLifecycle(0)\n        if (darkTheme \u003d\u003d 0) {\n            viewModel.updateDarkTheme(if (isSystemInDarkTheme()) 2 else 1)\n        }\n\n\n\n        ScreenshotThemeTransition(\n            isDarkTheme \u003d (darkTheme \u003d\u003d 2),\n            modifier \u003d Modifier\n        ) { startAnim -\u003e\n\n            MainScaffold(\n                isDarkTheme \u003d (darkTheme \u003d\u003d 2),\n                isAnimating \u003d false, // 这个参数现在不重要了\n                homeViewModel \u003d viewModel,\n\n                onThemeToggle \u003d { _, x, y -\u003e\n\n                    val isExpand \u003d (darkTheme \u003d\u003d 2)\n\n                    // 调用 startAnim\n                    // 参数1: 位置\n                    // 参数2: 扩张还是收缩\n                    // 参数3: 【核心】真正切换数据的操作，放在这里面\n                    startAnim(Offset(x, y), isExpand) {\n                        // 这个代码块会在截图完成后执行\n                        val newTheme \u003d when (darkTheme) {\n                            1 -\u003e true\n                            2 -\u003e false\n                            else -\u003e true\n                        }\n                        viewModel.updateDarkTheme(if (newTheme) 2 else 1)\n                        appPrefs.isNight \u003d newTheme\n\n                    }\n                },\n                navController \u003d navigator,\n            )\n        }\n    }\n}\n\n//非常棒的Material 3 Experiment\n@OptIn(ExperimentalMaterial3Api::class)\n//标题栏\n@Composable\nfun MainScaffold(\n    isDarkTheme: Boolean,\n    isAnimating: Boolean,\n    homeViewModel: HomeViewModel, // 接收 ViewModel\n    onThemeToggle: MaskAnimActive,\n    navController: Navigator\n) {\n\n\n    val pwd \u003d homeViewModel.currentPath.collectAsState()\n    val searchText \u003d homeViewModel.searchText.collectAsState()\n    homeViewModel.isSearch.collectAsState()\n    val focusManager \u003d LocalFocusManager.current\n    val focusRequester \u003d remember { FocusRequester() }\n\n    var shouldBlockBack by remember { mutableStateOf(false) }\n\n    LaunchedEffect(pwd.value) {\n        shouldBlockBack \u003d pwd.value !\u003d \&quot;/\&quot;\n\n\n    }\n\n    // 拦截系统返回\n    BackHandler(enabled \u003d shouldBlockBack) {\n        // 你可以弹窗确认、执行某些操作等\n        homeViewModel.handleBackPress()\n    }\n\n\n\n    Scaffold(\n        contentWindowInsets \u003d WindowInsets(bottom \u003d 0),\n\n        modifier \u003d Modifier\n            .fillMaxSize()\n            .pointerInput(Unit) {\n                detectTapGestures(onTap \u003d {\n                    focusManager.clearFocus() // 点击外部取消焦点\n                })\n            },\n        topBar \u003d {\n            Column(\n                horizontalAlignment \u003d Alignment.CenterHorizontally\n            ) {\n\n                key(isDarkTheme) {\n\n                    TopAppBar(\n                        title \u003d {\n\n                            AnimatedContent(\n                                targetState \u003d pwd.value, // 监视 pwd 的变化\n                                transitionSpec \u003d {\n                                    // 定义进入和退出动画\n                                    // 旧内容向左滑动并淡出，新内容从右侧滑入并淡入\n                                    if (targetState.length \u003e initialState.length) {\n                                        (slideInHorizontally { fullWidth -\u003e fullWidth } + fadeIn())\n                                            .togetherWith(slideOutHorizontally { fullWidth -\u003e -fullWidth } + fadeOut())\n                                            // SizeTransform 会动画 AnimatedContent 容器的尺寸变化\n                                            .using(SizeTransform(clip \u003d false)) // clip \u003d false 防止内容在动画过程中被裁剪\n                                    } else {\n                                        (slideInHorizontally { fullWidth -\u003e -fullWidth } + fadeIn())\n                                            .togetherWith(slideOutHorizontally { fullWidth -\u003e fullWidth } + fadeOut())\n                                            // SizeTransform 会动画 AnimatedContent 容器的尺寸变化\n                                            .using(SizeTransform(clip \u003d false)) // clip \u003d false 防止内容在动画过程中被裁剪\n                                    }\n\n                                },\n                                modifier \u003d Modifier.animateContentSize(animationSpec \u003d tween(150)), // 仍然保留 animateContentSize 来动画 Text 组件自身的尺寸变化\n                                label \u003d \&quot;PathTextAnimation\&quot;\n                            ) { targetPwd -\u003e // targetPwd 是当前动画的目标 pwd 值\n                                Text(\n                                    if (targetPwd \u003d\u003d \&quot;/\&quot;) \&quot;期末无挂\&quot; else if (targetPwd.length \u003e\u003d 8) \&quot;..\&quot; + targetPwd.substring(\n                                        targetPwd.length - 8\n                                    ) else targetPwd,\n//                                modifier \u003d Modifier.animateContentSize(),\n                                    maxLines \u003d 1, // 确保文本在一行内，方便水平滑动动画\n                                    overflow \u003d TextOverflow.Ellipsis\n                                )\n                            }\n\n\n//                        Text(\n//                            if (pwd.value \u003d\u003d \&quot;/\&quot;) \&quot;期末无挂\&quot; else if (pwd.value.length \u003e\u003d 8) \&quot;..\&quot; + pwd.value.substring(\n//                                pwd.value.length - 8\n//                            ) else pwd.value,\n//                            modifier \u003d Modifier.animateContentSize(),\n//                        )\n                        },\n                        navigationIcon \u003d {\n                            if (pwd.value !\u003d \&quot;/\&quot;) {\n                                Icon(\n                                    modifier \u003d Modifier.padding(16.dp, 0.dp, 4.dp, 0.dp),\n                                    painter \u003d painterResource(R.drawable.folder_open_24px),\n                                    contentDescription \u003d null\n                                )\n                            } else {\n                                Icon(\n                                    modifier \u003d Modifier.padding(16.dp, 0.dp, 4.dp, 0.dp),\n                                    painter \u003d painterResource(R.drawable.biglogo),\n                                    contentDescription \u003d null\n                                )\n                            }\n\n                        },\n                        actions \u003d {\n                            //别忘了路径过长隐藏一些按钮，\n                            //好吧忘了，不对懒了\n                            ThemeToggleButton(\n                                isAnimating \u003d isAnimating,\n                                onThemeToggle \u003d onThemeToggle,\n                                homeViewModel\n                            )\n                            Spacer(modifier \u003d Modifier.width(4.dp))\n                            IconButton(onClick \u003d {\n                                navController.push(SettingScreen())\n                            }) {\n                                Icon(\n                                    imageVector \u003d Icons.Default.Settings,\n                                    contentDescription \u003d null,\n                                    tint \u003d MaterialTheme.colorScheme.onSurface\n                                )\n                            }\n                            Spacer(modifier \u003d Modifier.width(8.dp))\n                        }\n                    )\n                }\n\n                var searchJob: Job? \u003d null\n\n                OutlinedTextField(\n                    value \u003d searchText.value,\n                    onValueChange \u003d { newText -\u003e\n                        homeViewModel.setSearchText(newText)\n                        homeViewModel.setLoadingState(LoadingState.Loading)\n                        homeViewModel.setisSearch(false)\n\n                        searchJob?.cancel()\n                        searchJob \u003d CoroutineScope(Dispatchers.Main).launch {\n                            if (newText.isNotEmpty()) {\n                                delay(300) // 延迟300ms\n                                homeViewModel.setisSearch(true)\n                                homeViewModel.setLoadingState(LoadingState.Loaded)\n\n                            }\n                        }\n\n                    },\n                    placeholder \u003d { Text(\&quot;搜索\&quot;) },\n                    leadingIcon \u003d {\n                        Row {\n                            Spacer(Modifier.width(8.dp))\n\n                            Icon(\n                                imageVector \u003d Icons.Default.Search,\n                                contentDescription \u003d \&quot;搜索图标\&quot;\n                            )\n                        }\n                    },\n                    trailingIcon \u003d { // 右侧图标 (取消按钮)\n                        if (searchText.value.isNotEmpty()) { // 只有当有文字时才显示\n                            Row {\n                                Icon(\n                                    imageVector \u003d Icons.Default.Close,\n                                    contentDescription \u003d \&quot;清空输入\&quot;,\n                                    modifier \u003d Modifier.clickable { // 添加点击事件\n                                        homeViewModel.setSearchText(\&quot;\&quot;)\n                                        focusManager.clearFocus()\n                                    }\n                                )\n                                Spacer(Modifier.width(8.dp))\n\n                            }\n                        }\n                    },\n                    shape \u003d RoundedCornerShape(percent \u003d 50),\n                    singleLine \u003d true,\n\n                    modifier \u003d Modifier\n                        .fillMaxWidth()\n                        .padding(26.dp, 8.dp)\n                        .focusRequester(focusRequester)\n                )\n\n\n            }\n        },\n\n        ) { innerPadding -\u003e\n\n        Column {\n\n            MainContent(\n                modifier \u003d Modifier\n                    .padding(innerPadding),\n                homeViewModel,\n                navController\n            )\n\n\n        }\n    }\n}\n\n\n//主页\n\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun MainContent(\n    modifier: Modifier \u003d Modifier,\n    homeViewModel: HomeViewModel,\n    navController: Navigator\n) {\n    val backgroundColor \u003d MaterialTheme.colorScheme.background\n\n    val darkTheme by homeViewModel.darkTheme.collectAsStateWithLifecycle(0)\n\n    val backdrop \u003d rememberLayerBackdrop {\n        drawRect(backgroundColor) // 绘制背景色，防止透明导致重影\n        drawContent()             // 绘制下方的内容（即 MainContent）\n    }\n\n    // 2. 这里的 state 放在 Scaffold 层级\n    var selectedTabIndex by rememberSaveable { mutableIntStateOf(0) }\n\n\n    val appPrefs \u003d homeViewModel.appPre\n    val loadingState \u003d\n        homeViewModel.loadingState.collectAsState() // 从 ViewModel 收集 loadingState\n    val pwd \u003d homeViewModel.currentPath.collectAsState() // 从 ViewModel 收集 loadingState\n    val root \u003d homeViewModel.root.collectAsState() // 从 ViewModel 收集 loadingState\n    val searchText \u003d homeViewModel.searchText.collectAsState() // 从 ViewModel 收集 loadingState\n    val isSearch \u003d homeViewModel.isSearch.collectAsState()\n\n    val composition by rememberLottieComposition(LottieCompositionSpec.RawRes(R.raw.app_list_loading))\n    val progress by animateLottieCompositionAsState(\n        composition \u003d composition,\n        isPlaying \u003d loadingState.value \u003d\u003d LoadingState.Loading,\n        iterations \u003d LottieConstants.IterateForever,\n        speed \u003d 1f,\n    )\n\n\n    Box(\n        modifier \u003d modifier\n            .fillMaxSize()\n    ) {\n        Box(\n            modifier \u003d Modifier\n                .fillMaxSize()\n                // 1. 先画背景 (解决重影)\n                .drawBehind {\n                    drawRect(backgroundColor)\n                }\n                // 2. 再进行捕捉 (解决 Tab 看不到内容)\n                // 注意：layerBackdrop 必须加在这个包裹了所有内容的 Box 上\n                .layerBackdrop(backdrop)\n        ) {\n            AnimatedVisibility(\n                visible \u003d loadingState.value \u003d\u003d LoadingState.Loading,\n                enter \u003d fadeIn(animationSpec \u003d tween(durationMillis \u003d 100)),\n                exit \u003d fadeOut(animationSpec \u003d tween(durationMillis \u003d 50)),\n            ) {\n\n                LottieAnimation(\n                    composition \u003d composition,\n                    progress \u003d { progress },\n                    modifier \u003d modifier.offset(y \u003d (-128).dp)\n                )\n\n            }\n\n            AnimatedVisibility(\n                visible \u003d loadingState.value \u003d\u003d LoadingState.Loaded,\n                enter \u003d fadeIn(animationSpec \u003d tween(durationMillis \u003d 300)),\n                exit \u003d fadeOut(animationSpec \u003d tween(durationMillis \u003d 50)),\n            ) {\n\n                lateinit var newdata: List\u003cAny\u003e\n\n\n                if (searchText.value.isNotEmpty() \u0026\u0026 isSearch.value) {\n                    newdata \u003d FileManager.searchFiles(root.value, searchText.value)\n\n                } else if (pwd.value \u003d\u003d \&quot;/\&quot;) {\n                    val targetContent \u003d FileManager.getDirContent(root.value, pwd.value)\n                    targetContent?.let {\n                        newdata \u003d it.subDirs + it.files\n                    }\n                } else {\n                    val targetContent \u003d FileManager.getDirContent(root.value, pwd.value)\n                    targetContent?.let {\n                        newdata \u003d listOf(\n                            DirNode(\n                                name \u003d \&quot;..\&quot;,\n                                path \u003d \&quot;\&quot;,\n                            )\n                        ) + it.subDirs + it.files\n                    }\n                }\n\n\n                Box {\n\n                    LazyColumn {\n                        items(newdata) { item -\u003e\n                            if (item is DirNode) {\n                                FolderCard(name \u003d item.name, { name -\u003e\n                                    homeViewModel.navigateTo(name)\n                                })\n                            } else if (item is FileItem) {\n                                FileCard(item, homeViewModel, navController)\n                            }\n\n                        }\n                        item {\n                            Spacer(Modifier.height(128.dp))\n                        }\n                    }\n                }\n\n\n\n\n                if (appPrefs.update !\u003d 0) {\n                    // 第一次打开，记录时间\n                    val firstOpenTime by remember { mutableLongStateOf(appPrefs.day) }\n\n                    if (firstOpenTime \u003d\u003d -1L) {\n                        appPrefs.day \u003d System.currentTimeMillis()\n                    } else {\n                        if ((System.currentTimeMillis() - firstOpenTime) / (1000 * 60 * 60 * 24) \u003e\u003d appPrefs.update) {\n                            BounceUpButton({\n                                homeViewModel.updateRepositoryData()\n                            })\n                        }\n                    }\n                }\n            }\n        }\n\n\n        key(darkTheme) {\n            val contentColor \u003d if (darkTheme \u003d\u003d 1) Color.Black else Color.White\n            val iconColorFilter \u003d ColorFilter.tint(contentColor)\n\n            // 1. 定义唯一的 backdrop 控制器\n\n            LiquidBottomTabs(\n                myaccentColor \u003d MaterialTheme.colorScheme.primary,\n                selectedTabIndex \u003d { selectedTabIndex },\n                onTabSelected \u003d { selectedTabIndex \u003d it },\n                backdrop \u003d backdrop,  // 传入上面定义的那个 backdrop\n                tabsCount \u003d 3,\n                modifier \u003d Modifier\n                    .padding(horizontal \u003d 36.dp, vertical \u003d 16.dp) // 调整 padding\n                    .navigationBarsPadding() // 适配底部手势条\n                    .align(Alignment.BottomCenter) // 放在底部\n            ) {\n                repeat(3) { index -\u003e\n                    LiquidBottomTab({ selectedTabIndex \u003d index }) {\n                        Box(\n                            Modifier\n                                .size(28.dp)\n                                .paint(\n                                    painterResource(R.drawable.notifications_24px),\n                                    colorFilter \u003d iconColorFilter\n                                )\n                        )\n                        BasicText(\n                            \&quot;Tab ${index + 1}\&quot;,\n                            style \u003d TextStyle(contentColor, 12.sp)\n                        )\n                    }\n                }\n            }\n        }\n\n    }\n}\n\n```\n\u003c/file_contents\u003e\n\n\n\u003cfile_contents\u003e\n```kotlin:app/src/main/java/jnu/kulipai/exam/components/FileCard.kt, lines\u003dALL(1-282)\npackage jnu.kulipai.exam.components\n\nimport androidx.compose.animation.AnimatedVisibility\nimport androidx.compose.animation.core.Spring\nimport androidx.compose.animation.core.animateFloatAsState\nimport androidx.compose.animation.core.spring\nimport androidx.compose.animation.core.tween\nimport androidx.compose.animation.expandVertically\nimport androidx.compose.animation.fadeIn\nimport androidx.compose.animation.fadeOut\nimport androidx.compose.animation.shrinkVertically\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.Spacer\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.height\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.layout.width\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Share\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.ElevatedButton\nimport androidx.compose.material3.ExperimentalMaterial3ExpressiveApi\nimport androidx.compose.material3.HorizontalDivider\nimport androidx.compose.material3.Icon\nimport androidx.compose.material3.LoadingIndicator\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.OutlinedCard\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.setValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.rotate\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.res.painterResource\nimport androidx.compose.ui.text.font.FontWeight\nimport androidx.compose.ui.text.style.TextOverflow\nimport androidx.compose.ui.unit.dp\nimport cafe.adriel.voyager.navigator.Navigator\nimport jnu.kulipai.exam.R\nimport jnu.kulipai.exam.data.model.DownLoadState\nimport jnu.kulipai.exam.data.model.FileItem\nimport jnu.kulipai.exam.ui.screens.home.HomeViewModel\nimport jnu.kulipai.exam.ui.screens.pdf.PdfScreen\nimport jnu.kulipai.exam.util.Api\nimport jnu.kulipai.exam.util.Cache\nimport jnu.kulipai.exam.util.FileManager\nimport java.io.File\n\n\n@OptIn(ExperimentalMaterial3ExpressiveApi::class)\n@Composable\nfun FileCard(\n    item: FileItem,\n    homeViewModel: HomeViewModel,\n    navController: Navigator\n) { // 接收 FileItem 和 HomeViewModel\n\n    val context \u003d LocalContext.current\n    var downloadState by remember(item.path) { // key 设为 item.path，确保文件路径改变时重置状态\n        mutableStateOf(\n            if (FileManager.exists(context, item.path, true)) { // 使用 LocalContext.current\n                DownLoadState.Downloaded\n            } else {\n                DownLoadState.None\n            }\n        )\n    }\n\n    var expanded by remember { mutableStateOf(false) }\n\n    val angle by animateFloatAsState(\n        targetValue \u003d if (expanded) 180f else 0f,\n        animationSpec \u003d tween(durationMillis \u003d 300)\n    )\n\n    OutlinedCard(\n        modifier \u003d Modifier\n            .fillMaxWidth()\n            .padding(24.dp, 6.dp),\n        onClick \u003d { expanded \u003d !expanded },\n        shape \u003d RoundedCornerShape(24.dp),\n    ) {\n        Column {\n            Row(\n                modifier \u003d Modifier\n                    .fillMaxWidth()\n                    .padding(24.dp),\n                verticalAlignment \u003d Alignment.CenterVertically\n            ) {\n                Icon(\n                    painter \u003d painterResource(R.drawable.file_24px),\n                    tint \u003d MaterialTheme.colorScheme.onSurface,\n                    contentDescription \u003d null\n                )\n                Spacer(modifier \u003d Modifier.width(12.dp))\n                Column(modifier \u003d Modifier.weight(1f)) {\n                    Row(verticalAlignment \u003d Alignment.CenterVertically) {\n                        Text(\n                            text \u003d item.name,\n                            modifier \u003d Modifier.weight(1f),\n                            style \u003d MaterialTheme.typography.bodyLarge.copy(fontWeight \u003d FontWeight.Bold),\n                            maxLines \u003d 2,\n                            overflow \u003d TextOverflow.Ellipsis\n                        )\n                        Spacer(modifier \u003d Modifier.width(8.dp))\n                        Icon(\n                            modifier \u003d Modifier.rotate(angle),\n                            painter \u003d painterResource(R.drawable.keyboard_arrow_down_24px),\n                            contentDescription \u003d null\n                        )\n                    }\n                }\n            }\n            AnimatedVisibility(\n                visible \u003d expanded,\n                enter \u003d expandVertically(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioMediumBouncy,\n                        stiffness \u003d Spring.StiffnessLow\n                    )\n                ) + fadeIn(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioNoBouncy,\n                        stiffness \u003d Spring.StiffnessLow\n                    )\n                ),\n                exit \u003d shrinkVertically(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioNoBouncy,\n                        stiffness \u003d Spring.StiffnessMedium\n                    )\n                ) + fadeOut(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioNoBouncy,\n                        stiffness \u003d Spring.StiffnessLow\n                    )\n                )\n            ) {\n                Column {\n                    HorizontalDivider(modifier \u003d Modifier.padding(24.dp, 0.dp))\n                    Column(modifier \u003d Modifier.padding(24.dp, 16.dp)) {\n                        Row {\n                            Text(\&quot;路径: \&quot;)\n                            Text(item.path)\n                        }\n                        Spacer(modifier \u003d Modifier.height(8.dp))\n                        Text(\&quot;大小: ${Api.formatFileSize(item.size)}\&quot;)\n                        Spacer(modifier \u003d Modifier.height(8.dp))\n//                        Row(verticalAlignment \u003d Alignment.CenterVertically) {\n//                            Text(\&quot;直链: \&quot;)\n////                            CopyableTextWithShape(\&quot;Github\&quot;, item.github_raw_url)\n////                            Spacer(modifier \u003d Modifier.width(8.dp))\n////                            CopyableTextWithShape(\&quot;Gitee\&quot;, item.gitee_raw_url)\n////                            Spacer(modifier \u003d Modifier.width(8.dp))\n////                            CopyableTextWithShape(\&quot;Cloudflare\&quot;, item.cf_url)\n//                        }\n                        Row(\n                            modifier \u003d Modifier\n                                .fillMaxWidth()\n                                .padding(0.dp, 16.dp, 0.dp, 0.dp),\n                            horizontalArrangement \u003d Arrangement.End\n                        ) {\n\n                            //导出文件\n                            if (downloadState \u003d\u003d DownLoadState.Downloaded) {\n                                ElevatedButton(\n                                    onClick \u003d {\n\n                                        homeViewModel.exportFile(item.path)\n                                    },\n                                    contentPadding \u003d PaddingValues(\n                                        start \u003d 16.dp,\n                                        top \u003d 6.dp,\n                                        end \u003d 16.dp,\n                                        bottom \u003d 6.dp\n                                    )\n                                ) {\n                                    Text(\&quot;导出文件\&quot;)\n                                }\n                                Spacer(modifier \u003d Modifier.width(8.dp))\n                            }\n\n                            //pdf预览\n                            if (item.name.substringAfterLast(\&quot;.\&quot;) \u003d\u003d \&quot;pdf\&quot; \u0026\u0026 downloadState \u003d\u003d DownLoadState.Downloaded) {\n                                ElevatedButton(\n                                    onClick \u003d {\n                                        Cache.currentFile \u003d\n                                            File(context.getExternalFilesDir(\&quot;\&quot;), item.path)\n                                        Cache.currentName \u003d item.name\n                                        navController.push(PdfScreen())\n                                    },\n                                    contentPadding \u003d PaddingValues(\n                                        start \u003d 16.dp,\n                                        top \u003d 6.dp,\n                                        end \u003d 16.dp,\n                                        bottom \u003d 6.dp\n                                    )\n                                ) {\n                                    Icon(\n                                        painter \u003d painterResource(R.drawable.visibility_24px),\n                                        contentDescription \u003d null\n                                    )\n                                    Spacer(modifier \u003d Modifier.width(4.dp))\n                                    Text(\&quot;预览\&quot;)\n                                }\n                                Spacer(modifier \u003d Modifier.width(8.dp))\n                            }\n\n\n                            Button(\n                                onClick \u003d {\n                                    if (downloadState \u003d\u003d DownLoadState.None) {\n                                        // 直接调用 ViewModel 中的下载方法\n                                        homeViewModel.downloadFile(item) { state -\u003e\n                                            downloadState \u003d state // 更新 Composable 内部的下载状态\n                                        }\n                                    } else if (downloadState \u003d\u003d DownLoadState.Downloaded) {\n                                        // 打开\n                                        homeViewModel.openFileWithOtherApp(item.path)\n                                    }\n                                },\n                                contentPadding \u003d PaddingValues(\n                                    start \u003d 16.dp,\n                                    top \u003d 6.dp,\n                                    end \u003d 16.dp,\n                                    bottom \u003d 6.dp\n                                )\n                            ) {\n                                when (downloadState) {\n                                    DownLoadState.None -\u003e {\n                                        Icon(\n                                            painter \u003d painterResource(R.drawable.download_24px),\n                                            contentDescription \u003d null\n                                        )\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;下载\&quot;)\n                                    }\n\n                                    DownLoadState.DownLoading -\u003e {\n                                        LoadingIndicator(\n                                            color \u003d MaterialTheme.colorScheme.onPrimary,\n                                            modifier \u003d Modifier\n                                                .width(24.dp)\n                                                .height(24.dp),\n                                        )\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;下载中\&quot;)\n                                    }\n\n                                    DownLoadState.Downloaded -\u003e {\n                                        Icon(\n\n                                            Icons.Default.Share,\n                                            modifier \u003d Modifier.size(20.dp),\n                                            contentDescription \u003d null\n                                        )\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;打开\&quot;)\n                                    }\n\n                                    DownLoadState.Err -\u003e {\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;下载失败\&quot;)\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\u003c/file_contents\u003e\n\n\u003c/attached_files\u003e\n\u003c/additional_data\u003e\n\u003cuser_query\u003e\n我会导出很多个不同后缀的文件，怎么保证后缀不被改\n\u003c/user_query\u003e)]&quot;,&quot;timestamp&quot;:1765616112364,&quot;messages&quot;:[{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:[{&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;\n\u003cadditional_data\u003e\nBelow are some potentially helpful/relevant pieces of information for figuring out to respond\n\u003ccurrent_file\u003e\n```kotlin:app/src/main/java/jnu/kulipai/exam/ui/screens/home/HomeViewModel.kt, lines\u003dALL(1-310)\npackage jnu.kulipai.exam.ui.screens.home\n\nimport android.app.Application\nimport android.content.Intent\nimport android.net.Uri\nimport android.webkit.MimeTypeMap\nimport android.widget.Toast\nimport androidx.activity.result.ActivityResultLauncher\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.core.content.FileProvider\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport jnu.kulipai.exam.AppPreferences\nimport jnu.kulipai.exam.data.model.DirNode\nimport jnu.kulipai.exam.data.model.DownLoadState\nimport jnu.kulipai.exam.data.model.FileItem\nimport jnu.kulipai.exam.data.model.LoadingState\nimport jnu.kulipai.exam.data.repository.FileRepository\nimport jnu.kulipai.exam.ui.theme.ThemeSettingsManager\nimport jnu.kulipai.exam.util.Api\nimport kotlinx.coroutines.Dispatchers\nimport kotlinx.coroutines.delay\nimport kotlinx.coroutines.flow.MutableStateFlow\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.asStateFlow\nimport kotlinx.coroutines.launch\nimport java.io.File\nimport java.io.FileInputStream\nimport java.io.OutputStream\n\n//哇好像很方便，在一个地方统一管理需要context的函数\n//用流来管理全局变量，神奇的感觉:))))))\n\nclass HomeViewModel(\n    private val fileRepository: FileRepository,\n    private val appPreferences: AppPreferences,\n    private val application: Application,\n    private val themeSettingsManager: ThemeSettingsManager,\n\n    ) : ViewModel() {\n\n\n    var currentFile \u003d MutableStateFlow(File(\&quot;/\&quot;))\n\n\n    val darkTheme \u003d themeSettingsManager.darkTheme\n\n    fun updateDarkTheme(value: Int) \u003d\n        viewModelScope.launch(Dispatchers.IO) {\n            themeSettingsManager.setDarkTheme(value)\n        }\n\n\n    private var exportLauncher: ActivityResultLauncher\u003cString\u003e? \u003d null\n    fun setExportLauncher(arl: ActivityResultLauncher\u003cString\u003e) {\n        exportLauncher \u003d arl\n    }\n\n    lateinit var exportPath: String\n\n    private var _isSearch \u003d MutableStateFlow(false)\n    var isSearch \u003d _isSearch.asStateFlow()\n\n    fun setisSearch(bool: Boolean) {\n        _isSearch.value \u003d bool\n    }\n\n    val appPre \u003d appPreferences\n\n    private var _searchText \u003d MutableStateFlow(\&quot;\&quot;)\n    var searchText \u003d _searchText.asStateFlow()\n\n    fun setSearchText(text: String) {\n        _searchText.value \u003d text\n    }\n\n    private val _loadingState \u003d MutableStateFlow(LoadingState.Loading)\n    val loadingState: StateFlow\u003cLoadingState\u003e \u003d _loadingState.asStateFlow()\n\n\n    fun setLoadingState(newState: LoadingState) {\n        _loadingState.value \u003d newState // 只有在 ViewModel 内部才能修改 _loadingState.value\n    }\n\n\n    private val _currentPath \u003d MutableStateFlow(\&quot;/\&quot;)\n    val currentPath: StateFlow\u003cString\u003e \u003d _currentPath.asStateFlow()\n\n    private var _root \u003d MutableStateFlow(DirNode(\&quot;root\&quot;, \&quot;/\&quot;)) // ViewModel 持有 root 节点\n    val root: StateFlow\u003cDirNode\u003e \u003d _root\n\n\n    init {\n        loadDirectoryTree() // ViewModel 初始化时加载数据\n    }\n\n    private fun loadDirectoryTree() {\n        viewModelScope.launch {\n            _loadingState.value \u003d LoadingState.Loading\n            try {\n                _root.value \u003d fileRepository.getDirectoryTree(application) // 传入 application context\n                _loadingState.value \u003d LoadingState.Loaded\n            } catch (e: Exception) {\n                Toast.makeText(application, \&quot;加载失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n                _loadingState.value \u003d LoadingState.Err // 加载失败时进入错误状态\n            }\n        }\n    }\n\n    fun navigateTo(folderName: String) {\n        viewModelScope.launch {\n            _loadingState.value \u003d LoadingState.Step\n            delay(80) // 模拟动画或操作延迟\n            _currentPath.value \u003d if (folderName \u003d\u003d \&quot;..\&quot;) {\n                Api.DotDot(_currentPath.value)\n            } else {\n                _currentPath.value + \&quot;$folderName/\&quot;\n            }\n//            delay(100) // 模拟动画或操作延迟\n            _loadingState.value \u003d LoadingState.Loaded\n        }\n    }\n\n    fun handleBackPress() {\n        if (_currentPath.value !\u003d \&quot;/\&quot;) {\n            viewModelScope.launch {\n                _loadingState.value \u003d LoadingState.Step\n                delay(250)\n                _currentPath.value \u003d Api.DotDot(_currentPath.value)\n                _loadingState.value \u003d LoadingState.Loaded\n            }\n        } else {\n            // 如果在根目录，可以考虑关闭应用或者不作处理，具体取决于需求\n            // 注意：在 ViewModel 中不应该直接调用 finish()，而是通过事件回调通知 UI\n//            Toast.makeText(application, \&quot;已经在根目录啦\&quot;, Toast.LENGTH_SHORT).show()\n        }\n    }\n\n    fun updateRepositoryData() {\n        viewModelScope.launch {\n            _loadingState.value \u003d LoadingState.Loading\n            try {\n                File(application.filesDir, \&quot;cache.json\&quot;).delete()\n\n                // 这里直接调用 repository 的逻辑\n                val newRoot \u003d\n                    fileRepository.getDirectoryTree(application) // 假设 repository 有一个 forceUpdate 参数\n                _root.value \u003d newRoot\n                _loadingState.value \u003d LoadingState.Loaded\n                appPreferences.day \u003d System.currentTimeMillis()\n                Toast.makeText(application, \&quot;数据已更新！\&quot;, Toast.LENGTH_SHORT).show()\n            } catch (e: Exception) {\n                Toast.makeText(application, \&quot;更新失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n                _loadingState.value \u003d LoadingState.Loaded // 即使失败也要回到 Loaded 状态\n            }\n        }\n    }\n\n    // 可以添加文件下载的逻辑到 ViewModel\n    fun downloadFile(fileItem: FileItem, downloadCallback: (DownLoadState) -\u003e Unit) {\n        viewModelScope.launch {\n            downloadCallback(DownLoadState.DownLoading)\n            try {\n                val url \u003d fileItem.url\n                Api.downloadFileToInternal(\n                    application, // 使用 application context\n                    url,\n                    fileItem.path,\n                    true,\n                    { downloadCallback(DownLoadState.Downloaded) },\n                    { downloadCallback(DownLoadState.Err) }\n                )\n            } catch (e: Exception) {\n                Toast.makeText(application, \&quot;下载失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n                downloadCallback(DownLoadState.Err)\n            }\n        }\n    }\n\n\n    fun openFileWithOtherApp(relativePath: String) {\n        val file \u003d File(application.getExternalFilesDir(\&quot;\&quot;), relativePath)\n        if (!file.exists()) {\n            throw IllegalArgumentException(\&quot;File does not exist: $relativePath\&quot;)\n        }\n\n        val extension \u003d file.extension.lowercase()\n        val fallbackMimeTypes \u003d mapOf(\n            \&quot;md\&quot; to \&quot;text/plain\&quot;,\n            \&quot;markdown\&quot; to \&quot;text/plain\&quot;,\n            \&quot;lua\&quot; to \&quot;text/plain\&quot;,\n            \&quot;log\&quot; to \&quot;text/plain\&quot;,\n            \&quot;json\&quot; to \&quot;application/json\&quot;,\n            \&quot;xml\&quot; to \&quot;text/xml\&quot;,\n            \&quot;csv\&quot; to \&quot;text/csv\&quot;\n        )\n\n        val mimeType \u003d MimeTypeMap.getSingleton()\n            .getMimeTypeFromExtension(extension)\n            ?: fallbackMimeTypes[extension]\n            ?: \&quot;application/octet-stream\&quot;\n\n        val uri: Uri \u003d FileProvider.getUriForFile(\n            application,\n            \&quot;${application.packageName}.fileprovider\&quot;,\n            file\n        )\n\n        val intent \u003d Intent(Intent.ACTION_VIEW).apply {\n            setDataAndType(uri, mimeType)\n            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)\n            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK) // ✅ 必须加，因是 application context\n        }\n\n        val chooser \u003d Intent.createChooser(intent, \&quot;选择应用打开文件\&quot;).apply {\n            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK) // ✅ Chooser 也加\n        }\n\n        try {\n            application.startActivity(chooser)\n        } catch (e: Exception) {\n            Toast.makeText(\n                application, \&quot;找不到应用打开此文件，路径: $relativePath，类型: $mimeType\&quot;,\n                Toast.LENGTH_SHORT\n            ).show()\n        }\n    }\n\n    fun exportFileToUri(relativePath: String, targetUri: Uri) {\n        val file \u003d File(application.getExternalFilesDir(\&quot;\&quot;), relativePath)\n        if (!file.exists()) {\n            Toast.makeText(application, \&quot;源文件不存在: $relativePath\&quot;, Toast.LENGTH_SHORT).show()\n            return\n        }\n\n        try {\n            val inputStream \u003d FileInputStream(file)\n            val outputStream: OutputStream? \u003d\n                application.contentResolver.openOutputStream(targetUri)\n\n            if (outputStream \u003d\u003d null) {\n                Toast.makeText(application, \&quot;无法打开导出目标\&quot;, Toast.LENGTH_SHORT).show()\n                return\n            }\n\n            inputStream.use { input -\u003e\n                outputStream.use { output -\u003e\n                    input.copyTo(output)\n                }\n            }\n\n            Toast.makeText(application, \&quot;文件已成功导出\&quot;, Toast.LENGTH_SHORT).show()\n\n        } catch (e: Exception) {\n            e.printStackTrace()\n            Toast.makeText(application, \&quot;导出失败: ${e.message}\&quot;, Toast.LENGTH_SHORT).show()\n        }\n    }\n\n\n    fun createExportLauncher(\n        mime: String,\n        onResult: (Uri?) -\u003e Unit\n    ): ActivityResultLauncher\u003cString\u003e {\n        return application.registerForActivityResult(\n            ActivityResultContracts.CreateDocument(mime),\n            onResult\n        )\n    }\n\n    fun exportFile(relativePath: String) {\n        val fileName \u003d File(relativePath).name\n        val mime \u003d guessMimeType(fileName)\n\n        exportPath \u003d relativePath\n\n        val launcher \u003d createExportLauncher(mime) { uri -\u003e\n            uri?.let { exportFileToUri(relativePath, it) }\n        }\n\n        launcher.launch(fileName)\n    }\n\n\n    fun guessMimeType(fileName: String): String {\n        val ext \u003d fileName.substringAfterLast(\u0027.\u0027, \&quot;\&quot;).lowercase()\n        return when (ext) {\n            \&quot;pdf\&quot; -\u003e \&quot;application/pdf\&quot;\n            \&quot;jpg\&quot;, \&quot;jpeg\&quot; -\u003e \&quot;image/jpeg\&quot;\n            \&quot;png\&quot; -\u003e \&quot;image/png\&quot;\n            \&quot;webp\&quot; -\u003e \&quot;image/webp\&quot;\n            \&quot;mp4\&quot; -\u003e \&quot;video/mp4\&quot;\n            \&quot;mp3\&quot; -\u003e \&quot;audio/mpeg\&quot;\n            \&quot;txt\&quot; -\u003e \&quot;text/plain\&quot;\n            \&quot;json\&quot; -\u003e \&quot;application/json\&quot;\n            \&quot;zip\&quot; -\u003e \&quot;application/zip\&quot;\n            \&quot;rar\&quot; -\u003e \&quot;application/vnd.rar\&quot;\n            \&quot;7z\&quot; -\u003e \&quot;application/x-7z-compressed\&quot;\n            \&quot;apk\&quot; -\u003e \&quot;application/vnd.android.package-archive\&quot;\n            \&quot;doc\&quot; -\u003e \&quot;application/msword\&quot;\n            \&quot;docx\&quot; -\u003e \&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document\&quot;\n            \&quot;xls\&quot; -\u003e \&quot;application/vnd.ms-excel\&quot;\n            \&quot;xlsx\&quot; -\u003e \&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\&quot;\n            else -\u003e \&quot;application/octet-stream\&quot; // 兜底，关键！\n        }\n    }\n\n\n\n}\n```\n\u003c/current_file\u003e\n\n\n\u003clinter_errors\u003e\n## Linter Errors\n\nPath: app/src/main/java/jnu/kulipai/exam/ui/screens/home/HomeViewModel.kt\nErrors:\n\nLine 265: Unresolved reference \u0027registerForActivityResult\u0027.\n\u003c/linter_errors\u003e\n\n\n\u003cattached_files\u003e\n\u003cfile_contents\u003e\n```kotlin:app/src/main/java/jnu/kulipai/exam/ui/screens/home/HomeScreen.kt, lines\u003dALL(1-571)\npackage jnu.kulipai.exam.ui.screens.home\n\nimport androidx.activity.compose.BackHandler\nimport androidx.activity.compose.rememberLauncherForActivityResult\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.compose.animation.AnimatedContent\nimport androidx.compose.animation.AnimatedVisibility\nimport androidx.compose.animation.SizeTransform\nimport androidx.compose.animation.animateContentSize\nimport androidx.compose.animation.core.tween\nimport androidx.compose.animation.fadeIn\nimport androidx.compose.animation.fadeOut\nimport androidx.compose.animation.slideInHorizontally\nimport androidx.compose.animation.slideOutHorizontally\nimport androidx.compose.animation.togetherWith\nimport androidx.compose.foundation.clickable\nimport androidx.compose.foundation.gestures.detectTapGestures\nimport androidx.compose.foundation.isSystemInDarkTheme\nimport androidx.compose.foundation.layout.Box\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.Spacer\nimport androidx.compose.foundation.layout.WindowInsets\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.height\nimport androidx.compose.foundation.layout.navigationBarsPadding\nimport androidx.compose.foundation.layout.offset\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.layout.width\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.foundation.text.BasicText\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Close\nimport androidx.compose.material.icons.filled.Search\nimport androidx.compose.material.icons.filled.Settings\nimport androidx.compose.material3.ExperimentalMaterial3Api\nimport androidx.compose.material3.Icon\nimport androidx.compose.material3.IconButton\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.OutlinedTextField\nimport androidx.compose.material3.Scaffold\nimport androidx.compose.material3.Text\nimport androidx.compose.material3.TopAppBar\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.LaunchedEffect\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.key\nimport androidx.compose.runtime.mutableIntStateOf\nimport androidx.compose.runtime.mutableLongStateOf\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.saveable.rememberSaveable\nimport androidx.compose.runtime.setValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.drawBehind\nimport androidx.compose.ui.draw.paint\nimport androidx.compose.ui.focus.FocusRequester\nimport androidx.compose.ui.focus.focusRequester\nimport androidx.compose.ui.geometry.Offset\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.graphics.ColorFilter\nimport androidx.compose.ui.input.pointer.pointerInput\nimport androidx.compose.ui.platform.LocalFocusManager\nimport androidx.compose.ui.res.painterResource\nimport androidx.compose.ui.text.TextStyle\nimport androidx.compose.ui.text.style.TextOverflow\nimport androidx.compose.ui.unit.dp\nimport androidx.compose.ui.unit.sp\nimport androidx.lifecycle.compose.collectAsStateWithLifecycle\nimport cafe.adriel.voyager.core.screen.Screen\nimport cafe.adriel.voyager.navigator.LocalNavigator\nimport cafe.adriel.voyager.navigator.Navigator\nimport cafe.adriel.voyager.navigator.currentOrThrow\nimport com.airbnb.lottie.compose.LottieAnimation\nimport com.airbnb.lottie.compose.LottieCompositionSpec\nimport com.airbnb.lottie.compose.LottieConstants\nimport com.airbnb.lottie.compose.animateLottieCompositionAsState\nimport com.airbnb.lottie.compose.rememberLottieComposition\nimport com.kyant.backdrop.backdrops.layerBackdrop\nimport com.kyant.backdrop.backdrops.rememberLayerBackdrop\nimport jnu.kulipai.exam.R\nimport jnu.kulipai.exam.components.BounceUpButton\nimport jnu.kulipai.exam.components.FileCard\nimport jnu.kulipai.exam.components.FolderCard\nimport jnu.kulipai.exam.components.LiquidBottomTab\nimport jnu.kulipai.exam.components.LiquidBottomTabs\nimport jnu.kulipai.exam.components.ThemeToggleButton\nimport jnu.kulipai.exam.data.model.DirNode\nimport jnu.kulipai.exam.data.model.FileItem\nimport jnu.kulipai.exam.data.model.LoadingState\nimport jnu.kulipai.exam.data.model.MaskAnimActive\nimport jnu.kulipai.exam.ui.screens.setting.SettingScreen\nimport jnu.kulipai.exam.ui.util.ScreenshotThemeTransition\nimport jnu.kulipai.exam.util.FileManager\nimport kotlinx.coroutines.CoroutineScope\nimport kotlinx.coroutines.Dispatchers\nimport kotlinx.coroutines.Job\nimport kotlinx.coroutines.delay\nimport kotlinx.coroutines.launch\nimport org.koin.androidx.compose.koinViewModel\n\n\n//这里有笼罩动画，状态栏\nclass MainScreen : Screen {\n\n    @Composable\n    override fun Content() {\n\n        val navigator \u003d LocalNavigator.currentOrThrow\n\n\n        val viewModel: HomeViewModel \u003d koinViewModel()\n        val launcher \u003d\n            rememberLauncherForActivityResult(ActivityResultContracts.CreateDocument(\&quot;text/plain\&quot;)) { uri -\u003e\n                uri?.let {\n                    viewModel.exportFileToUri(viewModel.exportPath, it)\n                }\n            }\n\n        // 设置 launcher 给 ViewModel\n        LaunchedEffect(Unit) {\n            viewModel.setExportLauncher(launcher)\n        }\n        // wow 这个单例原来可以哦哦，对的\n        // 单例然后保存到viewModel然后就获取然后就唯一的\n        // 全局的!\n        val appPrefs \u003d viewModel.appPre\n        // 初始化一次\n\n        // 这个好乱，我问ai怎么优化代码，他让我再写一个类就写一个配置一行代码，我说能不能写进viewModel\n        // ai说x，要写进一个新文件，\n        // 我说f**k(\n        // 已经优化掉了，当我没说\n\n\n        val darkTheme by viewModel.darkTheme.collectAsStateWithLifecycle(0)\n        if (darkTheme \u003d\u003d 0) {\n            viewModel.updateDarkTheme(if (isSystemInDarkTheme()) 2 else 1)\n        }\n\n\n\n        ScreenshotThemeTransition(\n            isDarkTheme \u003d (darkTheme \u003d\u003d 2),\n            modifier \u003d Modifier\n        ) { startAnim -\u003e\n\n            MainScaffold(\n                isDarkTheme \u003d (darkTheme \u003d\u003d 2),\n                isAnimating \u003d false, // 这个参数现在不重要了\n                homeViewModel \u003d viewModel,\n\n                onThemeToggle \u003d { _, x, y -\u003e\n\n                    val isExpand \u003d (darkTheme \u003d\u003d 2)\n\n                    // 调用 startAnim\n                    // 参数1: 位置\n                    // 参数2: 扩张还是收缩\n                    // 参数3: 【核心】真正切换数据的操作，放在这里面\n                    startAnim(Offset(x, y), isExpand) {\n                        // 这个代码块会在截图完成后执行\n                        val newTheme \u003d when (darkTheme) {\n                            1 -\u003e true\n                            2 -\u003e false\n                            else -\u003e true\n                        }\n                        viewModel.updateDarkTheme(if (newTheme) 2 else 1)\n                        appPrefs.isNight \u003d newTheme\n\n                    }\n                },\n                navController \u003d navigator,\n            )\n        }\n    }\n}\n\n//非常棒的Material 3 Experiment\n@OptIn(ExperimentalMaterial3Api::class)\n//标题栏\n@Composable\nfun MainScaffold(\n    isDarkTheme: Boolean,\n    isAnimating: Boolean,\n    homeViewModel: HomeViewModel, // 接收 ViewModel\n    onThemeToggle: MaskAnimActive,\n    navController: Navigator\n) {\n\n\n    val pwd \u003d homeViewModel.currentPath.collectAsState()\n    val searchText \u003d homeViewModel.searchText.collectAsState()\n    homeViewModel.isSearch.collectAsState()\n    val focusManager \u003d LocalFocusManager.current\n    val focusRequester \u003d remember { FocusRequester() }\n\n    var shouldBlockBack by remember { mutableStateOf(false) }\n\n    LaunchedEffect(pwd.value) {\n        shouldBlockBack \u003d pwd.value !\u003d \&quot;/\&quot;\n\n\n    }\n\n    // 拦截系统返回\n    BackHandler(enabled \u003d shouldBlockBack) {\n        // 你可以弹窗确认、执行某些操作等\n        homeViewModel.handleBackPress()\n    }\n\n\n\n    Scaffold(\n        contentWindowInsets \u003d WindowInsets(bottom \u003d 0),\n\n        modifier \u003d Modifier\n            .fillMaxSize()\n            .pointerInput(Unit) {\n                detectTapGestures(onTap \u003d {\n                    focusManager.clearFocus() // 点击外部取消焦点\n                })\n            },\n        topBar \u003d {\n            Column(\n                horizontalAlignment \u003d Alignment.CenterHorizontally\n            ) {\n\n                key(isDarkTheme) {\n\n                    TopAppBar(\n                        title \u003d {\n\n                            AnimatedContent(\n                                targetState \u003d pwd.value, // 监视 pwd 的变化\n                                transitionSpec \u003d {\n                                    // 定义进入和退出动画\n                                    // 旧内容向左滑动并淡出，新内容从右侧滑入并淡入\n                                    if (targetState.length \u003e initialState.length) {\n                                        (slideInHorizontally { fullWidth -\u003e fullWidth } + fadeIn())\n                                            .togetherWith(slideOutHorizontally { fullWidth -\u003e -fullWidth } + fadeOut())\n                                            // SizeTransform 会动画 AnimatedContent 容器的尺寸变化\n                                            .using(SizeTransform(clip \u003d false)) // clip \u003d false 防止内容在动画过程中被裁剪\n                                    } else {\n                                        (slideInHorizontally { fullWidth -\u003e -fullWidth } + fadeIn())\n                                            .togetherWith(slideOutHorizontally { fullWidth -\u003e fullWidth } + fadeOut())\n                                            // SizeTransform 会动画 AnimatedContent 容器的尺寸变化\n                                            .using(SizeTransform(clip \u003d false)) // clip \u003d false 防止内容在动画过程中被裁剪\n                                    }\n\n                                },\n                                modifier \u003d Modifier.animateContentSize(animationSpec \u003d tween(150)), // 仍然保留 animateContentSize 来动画 Text 组件自身的尺寸变化\n                                label \u003d \&quot;PathTextAnimation\&quot;\n                            ) { targetPwd -\u003e // targetPwd 是当前动画的目标 pwd 值\n                                Text(\n                                    if (targetPwd \u003d\u003d \&quot;/\&quot;) \&quot;期末无挂\&quot; else if (targetPwd.length \u003e\u003d 8) \&quot;..\&quot; + targetPwd.substring(\n                                        targetPwd.length - 8\n                                    ) else targetPwd,\n//                                modifier \u003d Modifier.animateContentSize(),\n                                    maxLines \u003d 1, // 确保文本在一行内，方便水平滑动动画\n                                    overflow \u003d TextOverflow.Ellipsis\n                                )\n                            }\n\n\n//                        Text(\n//                            if (pwd.value \u003d\u003d \&quot;/\&quot;) \&quot;期末无挂\&quot; else if (pwd.value.length \u003e\u003d 8) \&quot;..\&quot; + pwd.value.substring(\n//                                pwd.value.length - 8\n//                            ) else pwd.value,\n//                            modifier \u003d Modifier.animateContentSize(),\n//                        )\n                        },\n                        navigationIcon \u003d {\n                            if (pwd.value !\u003d \&quot;/\&quot;) {\n                                Icon(\n                                    modifier \u003d Modifier.padding(16.dp, 0.dp, 4.dp, 0.dp),\n                                    painter \u003d painterResource(R.drawable.folder_open_24px),\n                                    contentDescription \u003d null\n                                )\n                            } else {\n                                Icon(\n                                    modifier \u003d Modifier.padding(16.dp, 0.dp, 4.dp, 0.dp),\n                                    painter \u003d painterResource(R.drawable.biglogo),\n                                    contentDescription \u003d null\n                                )\n                            }\n\n                        },\n                        actions \u003d {\n                            //别忘了路径过长隐藏一些按钮，\n                            //好吧忘了，不对懒了\n                            ThemeToggleButton(\n                                isAnimating \u003d isAnimating,\n                                onThemeToggle \u003d onThemeToggle,\n                                homeViewModel\n                            )\n                            Spacer(modifier \u003d Modifier.width(4.dp))\n                            IconButton(onClick \u003d {\n                                navController.push(SettingScreen())\n                            }) {\n                                Icon(\n                                    imageVector \u003d Icons.Default.Settings,\n                                    contentDescription \u003d null,\n                                    tint \u003d MaterialTheme.colorScheme.onSurface\n                                )\n                            }\n                            Spacer(modifier \u003d Modifier.width(8.dp))\n                        }\n                    )\n                }\n\n                var searchJob: Job? \u003d null\n\n                OutlinedTextField(\n                    value \u003d searchText.value,\n                    onValueChange \u003d { newText -\u003e\n                        homeViewModel.setSearchText(newText)\n                        homeViewModel.setLoadingState(LoadingState.Loading)\n                        homeViewModel.setisSearch(false)\n\n                        searchJob?.cancel()\n                        searchJob \u003d CoroutineScope(Dispatchers.Main).launch {\n                            if (newText.isNotEmpty()) {\n                                delay(300) // 延迟300ms\n                                homeViewModel.setisSearch(true)\n                                homeViewModel.setLoadingState(LoadingState.Loaded)\n\n                            }\n                        }\n\n                    },\n                    placeholder \u003d { Text(\&quot;搜索\&quot;) },\n                    leadingIcon \u003d {\n                        Row {\n                            Spacer(Modifier.width(8.dp))\n\n                            Icon(\n                                imageVector \u003d Icons.Default.Search,\n                                contentDescription \u003d \&quot;搜索图标\&quot;\n                            )\n                        }\n                    },\n                    trailingIcon \u003d { // 右侧图标 (取消按钮)\n                        if (searchText.value.isNotEmpty()) { // 只有当有文字时才显示\n                            Row {\n                                Icon(\n                                    imageVector \u003d Icons.Default.Close,\n                                    contentDescription \u003d \&quot;清空输入\&quot;,\n                                    modifier \u003d Modifier.clickable { // 添加点击事件\n                                        homeViewModel.setSearchText(\&quot;\&quot;)\n                                        focusManager.clearFocus()\n                                    }\n                                )\n                                Spacer(Modifier.width(8.dp))\n\n                            }\n                        }\n                    },\n                    shape \u003d RoundedCornerShape(percent \u003d 50),\n                    singleLine \u003d true,\n\n                    modifier \u003d Modifier\n                        .fillMaxWidth()\n                        .padding(26.dp, 8.dp)\n                        .focusRequester(focusRequester)\n                )\n\n\n            }\n        },\n\n        ) { innerPadding -\u003e\n\n        Column {\n\n            MainContent(\n                modifier \u003d Modifier\n                    .padding(innerPadding),\n                homeViewModel,\n                navController\n            )\n\n\n        }\n    }\n}\n\n\n//主页\n\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun MainContent(\n    modifier: Modifier \u003d Modifier,\n    homeViewModel: HomeViewModel,\n    navController: Navigator\n) {\n    val backgroundColor \u003d MaterialTheme.colorScheme.background\n\n    val darkTheme by homeViewModel.darkTheme.collectAsStateWithLifecycle(0)\n\n    val backdrop \u003d rememberLayerBackdrop {\n        drawRect(backgroundColor) // 绘制背景色，防止透明导致重影\n        drawContent()             // 绘制下方的内容（即 MainContent）\n    }\n\n    // 2. 这里的 state 放在 Scaffold 层级\n    var selectedTabIndex by rememberSaveable { mutableIntStateOf(0) }\n\n\n    val appPrefs \u003d homeViewModel.appPre\n    val loadingState \u003d\n        homeViewModel.loadingState.collectAsState() // 从 ViewModel 收集 loadingState\n    val pwd \u003d homeViewModel.currentPath.collectAsState() // 从 ViewModel 收集 loadingState\n    val root \u003d homeViewModel.root.collectAsState() // 从 ViewModel 收集 loadingState\n    val searchText \u003d homeViewModel.searchText.collectAsState() // 从 ViewModel 收集 loadingState\n    val isSearch \u003d homeViewModel.isSearch.collectAsState()\n\n    val composition by rememberLottieComposition(LottieCompositionSpec.RawRes(R.raw.app_list_loading))\n    val progress by animateLottieCompositionAsState(\n        composition \u003d composition,\n        isPlaying \u003d loadingState.value \u003d\u003d LoadingState.Loading,\n        iterations \u003d LottieConstants.IterateForever,\n        speed \u003d 1f,\n    )\n\n\n    Box(\n        modifier \u003d modifier\n            .fillMaxSize()\n    ) {\n        Box(\n            modifier \u003d Modifier\n                .fillMaxSize()\n                // 1. 先画背景 (解决重影)\n                .drawBehind {\n                    drawRect(backgroundColor)\n                }\n                // 2. 再进行捕捉 (解决 Tab 看不到内容)\n                // 注意：layerBackdrop 必须加在这个包裹了所有内容的 Box 上\n                .layerBackdrop(backdrop)\n        ) {\n            AnimatedVisibility(\n                visible \u003d loadingState.value \u003d\u003d LoadingState.Loading,\n                enter \u003d fadeIn(animationSpec \u003d tween(durationMillis \u003d 100)),\n                exit \u003d fadeOut(animationSpec \u003d tween(durationMillis \u003d 50)),\n            ) {\n\n                LottieAnimation(\n                    composition \u003d composition,\n                    progress \u003d { progress },\n                    modifier \u003d modifier.offset(y \u003d (-128).dp)\n                )\n\n            }\n\n            AnimatedVisibility(\n                visible \u003d loadingState.value \u003d\u003d LoadingState.Loaded,\n                enter \u003d fadeIn(animationSpec \u003d tween(durationMillis \u003d 300)),\n                exit \u003d fadeOut(animationSpec \u003d tween(durationMillis \u003d 50)),\n            ) {\n\n                lateinit var newdata: List\u003cAny\u003e\n\n\n                if (searchText.value.isNotEmpty() \u0026\u0026 isSearch.value) {\n                    newdata \u003d FileManager.searchFiles(root.value, searchText.value)\n\n                } else if (pwd.value \u003d\u003d \&quot;/\&quot;) {\n                    val targetContent \u003d FileManager.getDirContent(root.value, pwd.value)\n                    targetContent?.let {\n                        newdata \u003d it.subDirs + it.files\n                    }\n                } else {\n                    val targetContent \u003d FileManager.getDirContent(root.value, pwd.value)\n                    targetContent?.let {\n                        newdata \u003d listOf(\n                            DirNode(\n                                name \u003d \&quot;..\&quot;,\n                                path \u003d \&quot;\&quot;,\n                            )\n                        ) + it.subDirs + it.files\n                    }\n                }\n\n\n                Box {\n\n                    LazyColumn {\n                        items(newdata) { item -\u003e\n                            if (item is DirNode) {\n                                FolderCard(name \u003d item.name, { name -\u003e\n                                    homeViewModel.navigateTo(name)\n                                })\n                            } else if (item is FileItem) {\n                                FileCard(item, homeViewModel, navController)\n                            }\n\n                        }\n                        item {\n                            Spacer(Modifier.height(128.dp))\n                        }\n                    }\n                }\n\n\n\n\n                if (appPrefs.update !\u003d 0) {\n                    // 第一次打开，记录时间\n                    val firstOpenTime by remember { mutableLongStateOf(appPrefs.day) }\n\n                    if (firstOpenTime \u003d\u003d -1L) {\n                        appPrefs.day \u003d System.currentTimeMillis()\n                    } else {\n                        if ((System.currentTimeMillis() - firstOpenTime) / (1000 * 60 * 60 * 24) \u003e\u003d appPrefs.update) {\n                            BounceUpButton({\n                                homeViewModel.updateRepositoryData()\n                            })\n                        }\n                    }\n                }\n            }\n        }\n\n\n        key(darkTheme) {\n            val contentColor \u003d if (darkTheme \u003d\u003d 1) Color.Black else Color.White\n            val iconColorFilter \u003d ColorFilter.tint(contentColor)\n\n            // 1. 定义唯一的 backdrop 控制器\n\n            LiquidBottomTabs(\n                myaccentColor \u003d MaterialTheme.colorScheme.primary,\n                selectedTabIndex \u003d { selectedTabIndex },\n                onTabSelected \u003d { selectedTabIndex \u003d it },\n                backdrop \u003d backdrop,  // 传入上面定义的那个 backdrop\n                tabsCount \u003d 3,\n                modifier \u003d Modifier\n                    .padding(horizontal \u003d 36.dp, vertical \u003d 16.dp) // 调整 padding\n                    .navigationBarsPadding() // 适配底部手势条\n                    .align(Alignment.BottomCenter) // 放在底部\n            ) {\n                repeat(3) { index -\u003e\n                    LiquidBottomTab({ selectedTabIndex \u003d index }) {\n                        Box(\n                            Modifier\n                                .size(28.dp)\n                                .paint(\n                                    painterResource(R.drawable.notifications_24px),\n                                    colorFilter \u003d iconColorFilter\n                                )\n                        )\n                        BasicText(\n                            \&quot;Tab ${index + 1}\&quot;,\n                            style \u003d TextStyle(contentColor, 12.sp)\n                        )\n                    }\n                }\n            }\n        }\n\n    }\n}\n\n```\n\u003c/file_contents\u003e\n\n\n\u003cfile_contents\u003e\n```kotlin:app/src/main/java/jnu/kulipai/exam/components/FileCard.kt, lines\u003dALL(1-282)\npackage jnu.kulipai.exam.components\n\nimport androidx.compose.animation.AnimatedVisibility\nimport androidx.compose.animation.core.Spring\nimport androidx.compose.animation.core.animateFloatAsState\nimport androidx.compose.animation.core.spring\nimport androidx.compose.animation.core.tween\nimport androidx.compose.animation.expandVertically\nimport androidx.compose.animation.fadeIn\nimport androidx.compose.animation.fadeOut\nimport androidx.compose.animation.shrinkVertically\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.Spacer\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.height\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.layout.size\nimport androidx.compose.foundation.layout.width\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Share\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.ElevatedButton\nimport androidx.compose.material3.ExperimentalMaterial3ExpressiveApi\nimport androidx.compose.material3.HorizontalDivider\nimport androidx.compose.material3.Icon\nimport androidx.compose.material3.LoadingIndicator\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.OutlinedCard\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.setValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.rotate\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.res.painterResource\nimport androidx.compose.ui.text.font.FontWeight\nimport androidx.compose.ui.text.style.TextOverflow\nimport androidx.compose.ui.unit.dp\nimport cafe.adriel.voyager.navigator.Navigator\nimport jnu.kulipai.exam.R\nimport jnu.kulipai.exam.data.model.DownLoadState\nimport jnu.kulipai.exam.data.model.FileItem\nimport jnu.kulipai.exam.ui.screens.home.HomeViewModel\nimport jnu.kulipai.exam.ui.screens.pdf.PdfScreen\nimport jnu.kulipai.exam.util.Api\nimport jnu.kulipai.exam.util.Cache\nimport jnu.kulipai.exam.util.FileManager\nimport java.io.File\n\n\n@OptIn(ExperimentalMaterial3ExpressiveApi::class)\n@Composable\nfun FileCard(\n    item: FileItem,\n    homeViewModel: HomeViewModel,\n    navController: Navigator\n) { // 接收 FileItem 和 HomeViewModel\n\n    val context \u003d LocalContext.current\n    var downloadState by remember(item.path) { // key 设为 item.path，确保文件路径改变时重置状态\n        mutableStateOf(\n            if (FileManager.exists(context, item.path, true)) { // 使用 LocalContext.current\n                DownLoadState.Downloaded\n            } else {\n                DownLoadState.None\n            }\n        )\n    }\n\n    var expanded by remember { mutableStateOf(false) }\n\n    val angle by animateFloatAsState(\n        targetValue \u003d if (expanded) 180f else 0f,\n        animationSpec \u003d tween(durationMillis \u003d 300)\n    )\n\n    OutlinedCard(\n        modifier \u003d Modifier\n            .fillMaxWidth()\n            .padding(24.dp, 6.dp),\n        onClick \u003d { expanded \u003d !expanded },\n        shape \u003d RoundedCornerShape(24.dp),\n    ) {\n        Column {\n            Row(\n                modifier \u003d Modifier\n                    .fillMaxWidth()\n                    .padding(24.dp),\n                verticalAlignment \u003d Alignment.CenterVertically\n            ) {\n                Icon(\n                    painter \u003d painterResource(R.drawable.file_24px),\n                    tint \u003d MaterialTheme.colorScheme.onSurface,\n                    contentDescription \u003d null\n                )\n                Spacer(modifier \u003d Modifier.width(12.dp))\n                Column(modifier \u003d Modifier.weight(1f)) {\n                    Row(verticalAlignment \u003d Alignment.CenterVertically) {\n                        Text(\n                            text \u003d item.name,\n                            modifier \u003d Modifier.weight(1f),\n                            style \u003d MaterialTheme.typography.bodyLarge.copy(fontWeight \u003d FontWeight.Bold),\n                            maxLines \u003d 2,\n                            overflow \u003d TextOverflow.Ellipsis\n                        )\n                        Spacer(modifier \u003d Modifier.width(8.dp))\n                        Icon(\n                            modifier \u003d Modifier.rotate(angle),\n                            painter \u003d painterResource(R.drawable.keyboard_arrow_down_24px),\n                            contentDescription \u003d null\n                        )\n                    }\n                }\n            }\n            AnimatedVisibility(\n                visible \u003d expanded,\n                enter \u003d expandVertically(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioMediumBouncy,\n                        stiffness \u003d Spring.StiffnessLow\n                    )\n                ) + fadeIn(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioNoBouncy,\n                        stiffness \u003d Spring.StiffnessLow\n                    )\n                ),\n                exit \u003d shrinkVertically(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioNoBouncy,\n                        stiffness \u003d Spring.StiffnessMedium\n                    )\n                ) + fadeOut(\n                    animationSpec \u003d spring(\n                        dampingRatio \u003d Spring.DampingRatioNoBouncy,\n                        stiffness \u003d Spring.StiffnessLow\n                    )\n                )\n            ) {\n                Column {\n                    HorizontalDivider(modifier \u003d Modifier.padding(24.dp, 0.dp))\n                    Column(modifier \u003d Modifier.padding(24.dp, 16.dp)) {\n                        Row {\n                            Text(\&quot;路径: \&quot;)\n                            Text(item.path)\n                        }\n                        Spacer(modifier \u003d Modifier.height(8.dp))\n                        Text(\&quot;大小: ${Api.formatFileSize(item.size)}\&quot;)\n                        Spacer(modifier \u003d Modifier.height(8.dp))\n//                        Row(verticalAlignment \u003d Alignment.CenterVertically) {\n//                            Text(\&quot;直链: \&quot;)\n////                            CopyableTextWithShape(\&quot;Github\&quot;, item.github_raw_url)\n////                            Spacer(modifier \u003d Modifier.width(8.dp))\n////                            CopyableTextWithShape(\&quot;Gitee\&quot;, item.gitee_raw_url)\n////                            Spacer(modifier \u003d Modifier.width(8.dp))\n////                            CopyableTextWithShape(\&quot;Cloudflare\&quot;, item.cf_url)\n//                        }\n                        Row(\n                            modifier \u003d Modifier\n                                .fillMaxWidth()\n                                .padding(0.dp, 16.dp, 0.dp, 0.dp),\n                            horizontalArrangement \u003d Arrangement.End\n                        ) {\n\n                            //导出文件\n                            if (downloadState \u003d\u003d DownLoadState.Downloaded) {\n                                ElevatedButton(\n                                    onClick \u003d {\n\n                                        homeViewModel.exportFile(item.path)\n                                    },\n                                    contentPadding \u003d PaddingValues(\n                                        start \u003d 16.dp,\n                                        top \u003d 6.dp,\n                                        end \u003d 16.dp,\n                                        bottom \u003d 6.dp\n                                    )\n                                ) {\n                                    Text(\&quot;导出文件\&quot;)\n                                }\n                                Spacer(modifier \u003d Modifier.width(8.dp))\n                            }\n\n                            //pdf预览\n                            if (item.name.substringAfterLast(\&quot;.\&quot;) \u003d\u003d \&quot;pdf\&quot; \u0026\u0026 downloadState \u003d\u003d DownLoadState.Downloaded) {\n                                ElevatedButton(\n                                    onClick \u003d {\n                                        Cache.currentFile \u003d\n                                            File(context.getExternalFilesDir(\&quot;\&quot;), item.path)\n                                        Cache.currentName \u003d item.name\n                                        navController.push(PdfScreen())\n                                    },\n                                    contentPadding \u003d PaddingValues(\n                                        start \u003d 16.dp,\n                                        top \u003d 6.dp,\n                                        end \u003d 16.dp,\n                                        bottom \u003d 6.dp\n                                    )\n                                ) {\n                                    Icon(\n                                        painter \u003d painterResource(R.drawable.visibility_24px),\n                                        contentDescription \u003d null\n                                    )\n                                    Spacer(modifier \u003d Modifier.width(4.dp))\n                                    Text(\&quot;预览\&quot;)\n                                }\n                                Spacer(modifier \u003d Modifier.width(8.dp))\n                            }\n\n\n                            Button(\n                                onClick \u003d {\n                                    if (downloadState \u003d\u003d DownLoadState.None) {\n                                        // 直接调用 ViewModel 中的下载方法\n                                        homeViewModel.downloadFile(item) { state -\u003e\n                                            downloadState \u003d state // 更新 Composable 内部的下载状态\n                                        }\n                                    } else if (downloadState \u003d\u003d DownLoadState.Downloaded) {\n                                        // 打开\n                                        homeViewModel.openFileWithOtherApp(item.path)\n                                    }\n                                },\n                                contentPadding \u003d PaddingValues(\n                                    start \u003d 16.dp,\n                                    top \u003d 6.dp,\n                                    end \u003d 16.dp,\n                                    bottom \u003d 6.dp\n                                )\n                            ) {\n                                when (downloadState) {\n                                    DownLoadState.None -\u003e {\n                                        Icon(\n                                            painter \u003d painterResource(R.drawable.download_24px),\n                                            contentDescription \u003d null\n                                        )\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;下载\&quot;)\n                                    }\n\n                                    DownLoadState.DownLoading -\u003e {\n                                        LoadingIndicator(\n                                            color \u003d MaterialTheme.colorScheme.onPrimary,\n                                            modifier \u003d Modifier\n                                                .width(24.dp)\n                                                .height(24.dp),\n                                        )\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;下载中\&quot;)\n                                    }\n\n                                    DownLoadState.Downloaded -\u003e {\n                                        Icon(\n\n                                            Icons.Default.Share,\n                                            modifier \u003d Modifier.size(20.dp),\n                                            contentDescription \u003d null\n                                        )\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;打开\&quot;)\n                                    }\n\n                                    DownLoadState.Err -\u003e {\n                                        Spacer(modifier \u003d Modifier.width(4.dp))\n                                        Text(\&quot;下载失败\&quot;)\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\u003c/file_contents\u003e\n\n\u003c/attached_files\u003e\n\u003c/additional_data\u003e\n\u003cuser_query\u003e\n我会导出很多个不同后缀的文件，怎么保证后缀不被改\n\u003c/user_query\u003e&quot;}]},{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:[]}],&quot;draft_message&quot;:&quot;o&quot;}}" />
  </component>
</project>